# 3.0.0 Refactoring Plan

> **Note:** Steps 1-5 were referenced from `plan-funkyOrmRefactor.prompt.md`. Since that file is currently untitled/unsaved, I have included placeholders below. Please paste the original steps 1-5 here.

1.  **Fix Project Configuration** [COMPLETED]: Corrected the invalid `net10.0` target in `Funcular.Data.Orm.SqlServer.Tests.DotNet10` to `net9.0` and removed the erroneous `<Compile Remove="Visitors\Visitors\**" />` from the main csproj.

2.  **Establish Core Abstractions** [COMPLETED]: Moved `ISqlDataProvider` and generic interfaces from the SqlServer project to `Funcular.Data.Orm.Core`.

3.  **Clean Up Extensions** [COMPLETED]: Decomposed `ExtensionMethods.cs`. Moved generic utilities (`AddRange`, `Contains`, `ToDictionaryKey`, etc.) to `Funcular.Data.Orm.Core` and kept SQL-specific extensions in the SqlServer project.

4.  **Resolve Technical Debt** [COMPLETED]: Verified that `Insert` and `InsertAsync` correctly return the primary key. The `TODO` was likely stale or already addressed.

5.  **Refactor God Class** [MERGED INTO STEP 6]: Connection management logic is being refactored as part of the provider abstraction.

6. **Decouple Core from SqlClient** and Implement Provider Abstraction [IN PROGRESS]

To fully enable multi-provider support (SQLite, MySQL, PostgreSQL) and complete the architectural modernization, we must remove the hard dependency on SQL Server from the Core library.

### Goals
*   Allow `Funcular.Data.Orm.Core` to be used with any ADO.NET provider.
*   Isolate SQL Server-specific logic (T-SQL generation, `SqlConnection`) to the `Funcular.Data.Orm.SqlServer` project.

### Action Items

1.  **Refactor `ISqlDataProvider` Interface** [COMPLETED]
    *   Update `ISqlDataProvider` in `Funcular.Data.Orm.Core`.
    *   Change property `SqlConnection Connection { get; set; }` to `IDbConnection Connection { get; set; }`.
    *   Change property `SqlTransaction Transaction { get; set; }` to `IDbTransaction Transaction { get; set; }`.

2.  **Clean Up Core Dependencies** [COMPLETED]
    *   Remove the `Microsoft.Data.SqlClient` NuGet package reference from `Funcular.Data.Orm.Core.csproj`.
    *   Ensure `Funcular.Data.Orm.Core` only relies on `System.Data` and `System.Data.Common`.

3.  **Abstract SQL Generation (The "Dialect" Pattern)** [STARTED]
    *   Introduce a new interface (e.g., `ISqlDialect` or `ISqlGenerator`) in Core to handle syntax differences:
        *   Pagination (`TOP` vs `LIMIT` vs `OFFSET/FETCH`).
        *   Parameter prefixes (`@` vs `:`).
        *   Identifier quoting (`[` `]` vs `"` `"` vs `` ` ``).
        *   Data type mappings.
    *   Implement `SqlServerDialect` in the `Funcular.Data.Orm.SqlServer` project.

4.  **Update `SqlServerOrmDataProvider`** [COMPLETED]
    *   Adapt the class to implement the generic `IDbConnection`-based `ISqlDataProvider`.
    *   Inject or instantiate the `SqlServerDialect` for string generation.
    *   Cast `IDbConnection` to `SqlConnection` internally only when necessary (or avoid it entirely if generic ADO.NET methods suffice).
