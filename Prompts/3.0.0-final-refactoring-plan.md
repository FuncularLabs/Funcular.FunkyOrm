# 3.0.0 Final Refactoring Plan: Universal Provider Architecture

This document outlines the final architectural changes required to transform `Funcular.FunkyOrm` from a SQL Server-centric library into a truly provider-agnostic ORM. The goal is to absorb all breaking changes now (v3.0) to facilitate seamless addition of future providers (SQLite, PostgreSQL, MongoDB, etc.) without further disruption.

## 1. Interface Evolution & Renaming

To support non-SQL stores (like MongoDB) or different SQL flavors, the core interface must be decoupled from specific ADO.NET constructs where possible.

### Action Items
*   **Rename `ISqlDataProvider` to `IOrmDataProvider`**:
    *   This reflects the broader scope.
*   **Refine the Interface Contract**:
    *   **Problem**: The current interface includes `IDbConnection Connection { get; set; }`. This ties the ORM to ADO.NET. MongoDB or HTTP-based data sources do not use `IDbConnection`.
    *   **Solution**: 
        *   Create a base `IOrmDataProvider` containing only the pure CRUD methods (`Get<T>`, `Save<T>`, `Delete<T>`, `Query<T>`).
        *   Create a child interface `ISqlOrmProvider : IOrmDataProvider` that adds `IDbConnection` and `IDbTransaction` properties.
        *   Update `SqlServerOrmDataProvider` to implement `ISqlOrmProvider`.

## 2. Base Class Extraction (`OrmDataProvider`)

Currently, `SqlServerOrmDataProvider` contains reusable logic (reflection caching, property discovery, logging) mixed with SQL-specific implementation details.

### Action Items
*   **Create `OrmDataProvider` (Abstract Base Class)**:
    *   Move the following into this base class:
        *   `_propertiesCache`, `_primaryKeys`, `_tableNames` (Reflection Caching).
        *   `Log` property and invocation logic.
        *   `GetTableName<T>()`, `GetPrimaryKey<T>()` helpers.
        *   Basic validation logic (e.g., checking for null entities).
*   **Create `SqlOrmDataProvider` (Abstract Base Class for ADO.NET)**:
    *   Inherits from `OrmDataProvider`.
    *   Implements `ISqlOrmProvider`.
    *   Handles `IDbConnection` and `IDbTransaction` management.
    *   Implements the "Template Method" pattern for CRUD operations (e.g., `Insert<T>` calls abstract `ExecuteInsert<T>`).
*   **Refactor `SqlServerOrmDataProvider`**:
    *   Inherit from `SqlOrmDataProvider`.
    *   Contain *only* SQL Server-specific logic (e.g., `SqlConnection` instantiation, specific error handling).

## 3. SQL Generation Strategy (The Generator Pattern)

To support SQLite, MySQL, and PostgreSQL, we must extract the SQL string construction logic out of the provider.

### Action Items
*   **Expand `ISqlDialect`**:
    *   Add methods for data type mapping (CLR Type -> SQL Type string).
    *   Add flags/methods for specific capabilities (e.g., `SupportsOutputClause`, `IdentityRetrievalMethod`).
*   **Create `SqlGenerator` Class**:
    *   Move the massive `BuildInsertCommandObject`, `CreateSelectQueryObject`, and `GenerateWhereClause` methods out of the provider and into a new `SqlGenerator` class.
    *   **Dependency Injection**: The `SqlGenerator` should take an `ISqlDialect` in its constructor.
    *   **Logic Flow**:
        1.  `SqlOrmDataProvider` holds a reference to `SqlGenerator`.
        2.  `SqlOrmDataProvider.Get<T>` calls `_sqlGenerator.CreateSelectStatement<T>()`.
        3.  `_sqlGenerator` uses `_dialect` to format quotes and parameters.
*   **Benefit**: Adding SQLite support becomes as simple as creating `SqliteDialect` and passing it to the standard `SqlGenerator`.

## 4. Directory & Namespace Reorganization

### Action Items
*   **Funcular.Data.Orm.Core**:
    *   `Interfaces/IOrmDataProvider.cs`
    *   `Interfaces/ISqlOrmProvider.cs`
    *   `Base/OrmDataProvider.cs`
    *   `Base/SqlOrmDataProvider.cs`
    *   `Generation/ISqlDialect.cs`
    *   `Generation/SqlGenerator.cs`
*   **Funcular.Data.Orm.SqlServer**:
    *   `SqlServerDialect.cs`
    *   `SqlServerOrmDataProvider.cs` (now very thin)

## 5. Execution Plan

1.  **Rename Interface** [COMPLETED]: Renamed `ISqlDataProvider` -> `IOrmDataProvider` and extracted `ISqlOrmProvider`.
2.  **Split Interface** [COMPLETED]: Extracted `ISqlOrmProvider` for ADO.NET specific members.
3.  **Extract Base Class**: Create `OrmDataProvider` and move caching/reflection logic.
4.  **Extract SQL Base**: Create `SqlOrmDataProvider` and move connection logic.
5.  **Extract Generator**: Move `Build*` methods to `SqlGenerator`.
6.  **Finalize SqlServer Provider**: Ensure `SqlServerOrmDataProvider` is just a configuration wrapper.
